name: Deploy to EC2 with tmux

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_KEY }}

    - name: Deploy to EC2 using tmux
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@52.78.212.96 << 'EOF'
          echo "=== ê¸°ì¡´ tmux ì„¸ì…˜ í™•ì¸ ==="
          
          # tmux session 0ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—°ê²°
          if tmux has-session -t 0 2>/dev/null; then
            echo "âœ… tmux session 0 ë°œê²¬ - ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"
            # ê¸°ì¡´ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (Ctrl+C)
            tmux send-keys -t 0 C-c
            sleep 3
            
            # ì¶”ê°€ë¡œ uvicorn í”„ë¡œì„¸ìŠ¤ê°€ ë‚¨ì•„ìˆë‹¤ë©´ ê°•ì œ ì¢…ë£Œ
            pkill -f uvicorn || true
            sleep 2
            
          else
            echo "âš ï¸ tmux session 0 ì—†ìŒ - ìƒˆë¡œ ìƒì„±"
            tmux new-session -d -s 0
          fi

          echo "=== í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™ ë° Git ì—…ë°ì´íŠ¸ ==="
          # blackcows-server í´ë”ë¡œ ì´ë™
          tmux send-keys -t 0 "cd ~/blackcows-server" Enter
          sleep 1
          
          # Git pull ì‹¤í–‰
          tmux send-keys -t 0 "git pull origin main" Enter
          sleep 3
          
          echo "=== Python ìºì‹œ íŒŒì¼ ì‚­ì œ ==="
          # Python ìºì‹œ íŒŒì¼ ì‚­ì œ
          find ~/blackcows-server -type f -name "*.pyc" -delete 2>/dev/null || true
          find ~/blackcows-server -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

          echo "=== Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ í™•ì¸ ==="
          cd ~/blackcows-server
          
          # Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ -f "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" ]; then
            echo "âœ… Firebase í‚¤ íŒŒì¼ ì¡´ì¬: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"
          else
            echo "âŒ Firebase í‚¤ íŒŒì¼ ì—†ìŒ: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"
            echo "íŒŒì¼ì„ í™•ì¸í•˜ê±°ë‚˜ ì˜¬ë°”ë¥¸ ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”."
            exit 1
          fi

          echo "=== í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ==="
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" > .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=30" >> .env
          echo "REFRESH_TOKEN_EXPIRE_DAYS=7" >> .env
          echo "ENVIRONMENT=production" >> .env
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "FIREBASE_PRIVATE_KEY_ID=${{ secrets.FIREBASE_PRIVATE_KEY_ID }}" >> .env
          echo "FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}" >> .env
          echo "FIREBASE_CLIENT_ID=${{ secrets.FIREBASE_CLIENT_ID }}" >> .env
          echo "FIREBASE_PRIVATE_KEY=\"${{ secrets.FIREBASE_PRIVATE_KEY }}\"" >> .env
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" >> .env
          echo "LIVESTOCK_TRACE_API_DECODING_KEY=${{ secrets.LIVESTOCK_TRACE_API_DECODING_KEY }}" >> .env
          echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
          echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
          echo "MAIL_FROM=${{ secrets.MAIL_FROM }}" >> .env
          echo "MAIL_SERVER=email-smtp.ap-northeast-2.amazonaws.com" >> .env
          echo "MAIL_PORT=587" >> .env
          echo "MAIL_TLS=True" >> .env
          echo "MAIL_SSL=False" >> .env

          # .env íŒŒì¼ ê¶Œí•œ ì„¤ì •
          chmod 600 .env

          echo "=== ê°€ìƒí™˜ê²½ ì„¤ì • ==="
          # ê°€ìƒí™˜ê²½ ìƒì„± (ì—†ì„ ê²½ìš°ì—ë§Œ)
          if [ ! -d "venv" ]; then
            echo "ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
            python3 -m venv venv
          fi
      
          # tmux ì„¸ì…˜ì—ì„œ ê°€ìƒí™˜ê²½ í™œì„±í™”
          tmux send-keys -t 0 "source venv/bin/activate" Enter
          sleep 2
      
          echo "=== íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ==="
          # tmux ì„¸ì…˜ì—ì„œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
          tmux send-keys -t 0 "pip install --upgrade pip" Enter
          sleep 3
          tmux send-keys -t 0 "pip install -r requirements.txt" Enter
          sleep 8

          echo "=== ìƒˆë¡œìš´ íŒŒì¼ êµ¬ì¡° í™•ì¸ ==="
          if [ -f "schemas/livestock_cow.py" ]; then
            echo "âœ… ì¶•ì‚°ë¬¼ì´ë ¥ì œ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì¡´ì¬"
          else
            echo "âš ï¸ ì¶•ì‚°ë¬¼ì´ë ¥ì œ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì—†ìŒ - ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          fi
          
          if [ -f "services/livestock_cow_service.py" ]; then
            echo "âœ… ì¶•ì‚°ë¬¼ì´ë ¥ì œ ì„œë¹„ìŠ¤ íŒŒì¼ ì¡´ì¬"
          else
            echo "âš ï¸ ì¶•ì‚°ë¬¼ì´ë ¥ì œ ì„œë¹„ìŠ¤ íŒŒì¼ ì—†ìŒ - ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          fi

          echo "=== Python êµ¬ë¬¸ ê²€ì‚¬ ==="
          python3 -m py_compile main.py
          
          if [ -f "schemas/livestock_cow.py" ]; then
            python3 -m py_compile schemas/livestock_cow.py
            echo "livestock_cow.py êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼"
          fi
          
          if [ -f "services/livestock_cow_service.py" ]; then
            python3 -m py_compile services/livestock_cow_service.py
            echo "livestock_cow_service.py êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼"
          fi

          echo "=== ì¶•ì‚°ë¬¼ì´ë ¥ì œ API ì„¤ì • í™•ì¸ ==="
          # ì¶•ì‚°ë¬¼ì´ë ¥ì œ API í‚¤ ì„¤ì • í™•ì¸
          if [ -n "${{ secrets.LIVESTOCK_TRACE_API_DECODING_KEY }}" ]; then
            echo "âœ… ì¶•ì‚°ë¬¼ì´ë ¥ì œ API í‚¤ ì„¤ì •ë¨"
          else
            echo "âš ï¸ ì¶•ì‚°ë¬¼ì´ë ¥ì œ API í‚¤ ë¯¸ì„¤ì • - ì—°ë™ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤"
            echo "   ìˆ˜ë™ ì –ì†Œ ë“±ë¡ì€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤"
          fi

          echo "=== ì„œë²„ ì‹œì‘ ==="
          # tmux ì„¸ì…˜ì—ì„œ í™˜ê²½ë³€ìˆ˜ ì„¤ì • í›„ ì„œë²„ ì‹œì‘
          tmux send-keys -t 0 "export GOOGLE_APPLICATION_CREDENTIALS=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" Enter
          sleep 1
          # ì¶•ì‚°ë¬¼ì´ë ¥ì œ API í‚¤ë„ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
          tmux send-keys -t 0 "export LIVESTOCK_TRACE_API_DECODING_KEY=${{ secrets.LIVESTOCK_TRACE_API_DECODING_KEY }}" Enter
          sleep 1
          tmux send-keys -t 0 "uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-level info --access-log" Enter
          
          echo "=== ì„œë²„ ì‹œì‘ ëŒ€ê¸° (15ì´ˆ) ==="
          sleep 15

          echo "=== tmux ì„¸ì…˜ ìƒíƒœ í™•ì¸ ==="
          if tmux has-session -t 0 2>/dev/null; then
            echo "âœ… tmux session 0 ì‹¤í–‰ ì¤‘"
            
            # ì„¸ì…˜ ë‚´ìš© í™•ì¸
            echo "=== tmux ì„¸ì…˜ ìµœê·¼ ë¡œê·¸ í™•ì¸(20ì¤„) ==="
            tmux capture-pane -t 0 -p | tail -20
            echo "ë¡œê·¸ í™•ì¸ ì‹œê°„: $(date)"
            
            # ì—ëŸ¬ê°€ ìˆëŠ”ì§€ ë³„ë„ í™•ì¸
            echo "=== ì—ëŸ¬ ë¡œê·¸ í™•ì¸ ==="
            ERROR_COUNT=$(tmux capture-pane -t 0 -p | grep -i error | wc -l)
            if [ $ERROR_COUNT -gt 0 ]; then
              echo "âš ï¸ ì—ëŸ¬ ë°œê²¬ ($ERROR_COUNTê°œ):"
              tmux capture-pane -t 0 -p | grep -i error | tail -5
            else
              echo "âœ… ì—ëŸ¬ ì—†ìŒ"
            fi
          else
            echo "âŒ tmux session 0 ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"
            exit 1
          fi

          echo "=== í¬íŠ¸ ìƒíƒœ í™•ì¸ ==="
          PORT_CHECK_SUCCESS=false
          
          # ss ëª…ë ¹ì–´ë¡œ í™•ì¸
          if ss -tlnp | grep ':8000'; then
            echo "âœ… í¬íŠ¸ 8000 ì‚¬ìš© ì¤‘ (ss í™•ì¸)"
            PORT_CHECK_SUCCESS=true
          fi
          
          # lsofë¡œë„ í™•ì¸
          if command -v lsof >/dev/null 2>&1; then
            if lsof -i:8000 >/dev/null 2>&1; then
              echo "âœ… í¬íŠ¸ 8000 ì‚¬ìš© ì¤‘ (lsof í™•ì¸)"
              PORT_CHECK_SUCCESS=true
            fi
          fi
          
          # Python í”„ë¡œì„¸ìŠ¤ë¡œë„ í™•ì¸
          if ps aux | grep uvicorn | grep -v grep | grep 8000; then
            echo "âœ… uvicorn í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘"
            PORT_CHECK_SUCCESS=true
          fi

          echo "=== í—¬ìŠ¤ì²´í¬ ==="
          sleep 5
          
          HEALTH_CHECK_SUCCESS=false
          ROOT_CHECK_SUCCESS=false
          LIVESTOCK_TRACE_CHECK=false
          
          # /health ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
          if curl -f -m 10 http://localhost:8000/health >/dev/null 2>&1; then
            echo "âœ… /health ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ ì„±ê³µ"
            HEALTH_CHECK_SUCCESS=true
          fi
          
          # ë£¨íŠ¸ ê²½ë¡œ í™•ì¸
          if curl -f -m 10 http://localhost:8000/ >/dev/null 2>&1; then
            echo "âœ… ë£¨íŠ¸ ê²½ë¡œ ì‘ë‹µ ì„±ê³µ"
            ROOT_CHECK_SUCCESS=true
          fi

          # ìµœì¢… ê²°ê³¼ íŒì •
          if [ "$HEALTH_CHECK_SUCCESS" = true ] || [ "$ROOT_CHECK_SUCCESS" = true ] || [ "$PORT_CHECK_SUCCESS" = true ]; then
            echo ""
            echo "ğŸ‰ ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ¯ ì„œë²„ ì ‘ì†: http://52.78.212.96:8000"
            echo "ğŸ“š API ë¬¸ì„œ: http://52.78.212.96:8000/docs"
            echo "ğŸ–¥ï¸ tmux ì„¸ì…˜ ì ‘ì†: tmux attach-session -t 0"
            echo ""
            echo "=== ë°°í¬ ìƒíƒœ ìš”ì•½ ==="
            echo "âœ… Git ì—…ë°ì´íŠ¸ ì™„ë£Œ (git pull origin main)"
            echo "âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
            echo "âœ… Firebase ì„¤ì • ì™„ë£Œ"
            echo "âœ… tmux session 0 ì—ì„œ ì„œë²„ ì‹¤í–‰ ì¤‘"
            echo "âœ… íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            if [ "$HEALTH_CHECK_SUCCESS" = true ]; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ í†µê³¼"
            fi
            if [ "$ROOT_CHECK_SUCCESS" = true ]; then
              echo "âœ… ë£¨íŠ¸ ê²½ë¡œ ì‘ë‹µ ì •ìƒ"
            fi
            if [ "$PORT_CHECK_SUCCESS" = true ]; then
              echo "âœ… í¬íŠ¸ 8000 ì •ìƒ ì‚¬ìš©"
            fi
            # ì¶•ì‚°ë¬¼ì´ë ¥ì œ ê¸°ëŠ¥ ìƒíƒœ í‘œì‹œ
            if [ "$LIVESTOCK_TRACE_CHECK" = true ]; then
              echo "âœ… ì¶•ì‚°ë¬¼ì´ë ¥ì œ ì—°ë™ ê¸°ëŠ¥ ì •ìƒ"
            else
              echo "âš ï¸ ì¶•ì‚°ë¬¼ì´ë ¥ì œ ì—°ë™ ê¸°ëŠ¥ ì œí•œë¨ (ìˆ˜ë™ ë“±ë¡ì€ ê°€ëŠ¥)"
            fi
            echo ""
            echo "ğŸš€ ë°°í¬ ì„±ê³µ!"
            echo "ğŸ’¡ ì„œë²„ ë¡œê·¸ í™•ì¸: tmux attach-session -t 0"
            echo "ğŸ’¡ tmux ì„¸ì…˜ ë‚˜ê°€ê¸°: Ctrl+B â†’ D"
            
            echo ""
            echo "API í…ŒìŠ¤íŠ¸:"
            echo "curl http://52.78.212.96:8000/health"
            
          else
            echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨ - ìƒì„¸ ë¡œê·¸ í™•ì¸"
            echo "=== tmux ì„¸ì…˜ ì „ì²´ ë¡œê·¸ ==="
            tmux capture-pane -t 0 -p
            echo "=== Python í”„ë¡œì„¸ìŠ¤ í™•ì¸ ==="
            ps aux | grep python
            exit 1
          fi

        EOF
