name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_KEY }}

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@52.78.212.96 << 'EOF'
          cd ~/blackcows-server
          git pull

          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" > .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=30" >> .env
          echo "REFRESH_TOKEN_EXPIRE_DAYS=7" >> .env
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "FIREBASE_PRIVATE_KEY_ID=${{ secrets.FIREBASE_PRIVATE_KEY_ID }}" >> .env
          echo "FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}" >> .env
          echo "FIREBASE_CLIENT_ID=${{ secrets.FIREBASE_CLIENT_ID }}" >> .env
          
          # FIREBASE_PRIVATE_KEY í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ (ìˆ˜ì •ëœ ë¶€ë¶„)
          echo "FIREBASE_PRIVATE_KEY=\"${{ secrets.FIREBASE_PRIVATE_KEY }}\"" >> .env

          # .env íŒŒì¼ ê¶Œí•œ ì„¤ì •
          chmod 600 .env

          # ê°€ìƒí™˜ê²½ ì—†ìœ¼ë©´ ìƒì„±
          [ ! -d "venv" ] && python3 -m venv venv
      
          # ê°€ìƒí™˜ê²½ í™œì„±í™”
          source venv/bin/activate
      
          # íŒ¨í‚¤ì§€ ì„¤ì¹˜
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # ì„œë²„ ì‹¤í–‰ ì „ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          fuser -k 8000/tcp || true
          pkill -f uvicorn || true
          
          # Python êµ¬ë¬¸ í…ŒìŠ¤íŠ¸
          echo "=== Python êµ¬ë¬¸ ê²€ì‚¬ ==="
          python3 -m py_compile main.py
          if [ $? -eq 0 ]; then
            echo "âœ… main.py êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼"
          else
            echo "âŒ main.py êµ¬ë¬¸ ì˜¤ë¥˜ ë°œê²¬"
            exit 1
          fi
           
          # main.py ë‚´ìš© í™•ì¸
          echo "=== main.py ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ==="
          if grep -q "/health" main.py; then
            echo "âœ… /health ì—”ë“œí¬ì¸íŠ¸ ë°œê²¬"
          else
            echo "âŒ /health ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ - ì¶”ê°€ í•„ìš”"
          fi

          # import os í™•ì¸
          echo "=== import os í™•ì¸ ==="
          if grep -q "import os" main.py; then
            echo "âœ… import os ë°œê²¬"
          else
            echo "âŒ import os ëˆ„ë½ - main.py ì²« ì¤„ì— ì¶”ê°€ í•„ìš”"
            exit 1
          fi

          # í™˜ê²½ë³€ìˆ˜ í…ŒìŠ¤íŠ¸ (ê°œì„ ëœ ë¶€ë¶„)
          echo "=== í™˜ê²½ë³€ìˆ˜ í™•ì¸ ==="
          python3 -c "
import os
from dotenv import load_dotenv
load_dotenv()
print('âœ… JWT_SECRET_KEY:', 'SET' if os.getenv('JWT_SECRET_KEY') else 'âŒ NOT SET')
print('âœ… FIREBASE_PROJECT_ID:', 'SET' if os.getenv('FIREBASE_PROJECT_ID') else 'âŒ NOT SET')
print('âœ… FIREBASE_PRIVATE_KEY:', 'SET' if os.getenv('FIREBASE_PRIVATE_KEY') else 'âŒ NOT SET')
print('âœ… All environment variables loaded successfully!')
"

          # Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ (ê°œì„ ëœ ë¶€ë¶„)
          echo "=== Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ==="
          python3 -c "
import os
from dotenv import load_dotenv
load_dotenv()
try:
    from config.firebase_config import initialize_firebase
    initialize_firebase()
    print('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ')
except Exception as e:
    print(f'âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: {e}')
    exit 1
"

          # ì„œë²„ ì‹¤í–‰
          echo "=== ì„œë²„ ì‹œì‘ ==="
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 < /dev/null &
          SERVER_PID=$!
          echo "ì„œë²„ PID: $SERVER_PID"

          # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
          sleep 5

          # í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸
          echo "=== í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸ ==="
          if ps -p $SERVER_PID > /dev/null; then
            echo "âœ… ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘ (PID: $SERVER_PID)"
          else
            echo "âŒ ì„œë²„ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë¨"
            echo "=== ì„œë²„ ë¡œê·¸ í™•ì¸ ==="
            cat server.log
            exit 1
          fi

          # í¬íŠ¸ í™•ì¸
          echo "=== í¬íŠ¸ ìƒíƒœ í™•ì¸ ==="
          if ss -tlnp | grep 8000; then
            echo "âœ… í¬íŠ¸ 8000ì´ ì—´ë ¤ìˆìŒ (ss ëª…ë ¹ì–´ ì‚¬ìš©)"
          elif lsof -i:8000 2>/dev/null; then
            echo "âœ… í¬íŠ¸ 8000ì´ ì—´ë ¤ìˆìŒ (lsof ëª…ë ¹ì–´ ì‚¬ìš©)"
          elif curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… í¬íŠ¸ 8000 í™•ì¸ë¨ (í—¬ìŠ¤ì²´í¬ ì„±ê³µ)"
          else
            echo "âŒ í¬íŠ¸ 8000 í™•ì¸ ì‹¤íŒ¨"
            echo "=== ì„œë²„ ë¡œê·¸ ==="
            cat server.log
            exit 1
          fi

          # ìµœì¢… í—¬ìŠ¤ì²´í¬
          echo "=== ìµœì¢… í—¬ìŠ¤ì²´í¬ ==="
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ - ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ¯ ì„œë²„ ì ‘ì†: http://52.78.212.96:8000"
            echo "ğŸ“š API ë¬¸ì„œ: http://52.78.212.96:8000/docs"
          elif curl -f http://localhost:8000/ > /dev/null 2>&1; then
            echo "âœ… ë£¨íŠ¸ ê²½ë¡œ ì‘ë‹µ í™•ì¸ - ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ¯ ì„œë²„ ì ‘ì†: http://52.78.212.96:8000"
          else
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            echo "=== ì„œë²„ ë¡œê·¸ í™•ì¸ ==="
            tail -30 server.log
          fi

          # ì„œë²„ ì‹œì‘ í™•ì¸
          sleep 3
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ ì„œë²„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            # ë¡œê·¸ í™•ì¸
            tail -20 nohup.out || echo "ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

        EOF
