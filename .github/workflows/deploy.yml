name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_KEY }}

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@52.78.212.96 << 'EOF'
          cd ~/blackcows-server
          git pull

          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„!)
          echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" > .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=30" >> .env
          echo "REFRESH_TOKEN_EXPIRE_DAYS=7" >> .env
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "FIREBASE_PRIVATE_KEY_ID=${{ secrets.FIREBASE_PRIVATE_KEY_ID }}" >> .env
          echo "FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}" >> .env
          echo "FIREBASE_CLIENT_ID=${{ secrets.FIREBASE_CLIENT_ID }}" >> .env
          echo 'FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}"' >> .env

          # .env íŒŒì¼ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ)
          chmod 600 .env

          # ê°€ìƒí™˜ê²½ ì—†ìœ¼ë©´ ìƒì„±
          [ ! -d "venv" ] && python3 -m venv venv
      
          # ê°€ìƒí™˜ê²½ í™œì„±í™”
          source venv/bin/activate
      
          # íŒ¨í‚¤ì§€ ì„¤ì¹˜
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # ì„œë²„ ì‹¤í–‰ ì „ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          fuser -k 8000/tcp || true

          # ğŸ§ª í™˜ê²½ë³€ìˆ˜ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
          echo "Testing environment variables..."
          python3 -c "
          import os
          from dotenv import load_dotenv
          load_dotenv()
          print('âœ… JWT_SECRET_KEY:', 'SET' if os.getenv('JWT_SECRET_KEY') else 'âŒ NOT SET')
          print('âœ… FIREBASE_PROJECT_ID:', os.getenv('FIREBASE_PROJECT_ID', 'âŒ NOT SET'))
          print('âœ… FIREBASE_PRIVATE_KEY_ID:', os.getenv('FIREBASE_PRIVATE_KEY_ID', 'âŒ NOT SET'))
          print('âœ… FIREBASE_CLIENT_EMAIL:', os.getenv('FIREBASE_CLIENT_EMAIL', 'âŒ NOT SET'))
          print('âœ… FIREBASE_CLIENT_ID:', os.getenv('FIREBASE_CLIENT_ID', 'âŒ NOT SET'))
          print('âœ… FIREBASE_PRIVATE_KEY:', os.getenv('FIREBASE_PRIVATE_KEY', 'âŒ NOT SET'))
          print('âœ… ACCESS_TOKEN_EXPIRE_MINUTES:', os.getenv('ACCESS_TOKEN_EXPIRE_MINUTES', 'âŒ NOT SET'))
          print('âœ… REFRESH_TOKEN_EXPIRE_DAYS:', os.getenv('REFRESH_TOKEN_EXPIRE_DAYS', 'âŒ NOT SET'))
          print('âœ… í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì™„ë£Œ!')
          "


          # ì„œë²„ ì‹¤í–‰ (ì¶œë ¥/ì…ë ¥ ë¶„ë¦¬)
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > /dev/null 2>&1 < /dev/null &

          # ì„œë²„ ì‹œì‘ í™•ì¸
          sleep 3
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ ì„œë²„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            # ë¡œê·¸ í™•ì¸
            tail -20 nohup.out || echo "ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

        EOF
