name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_KEY }}

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@52.78.212.96 << 'EOF'
          cd ~/blackcows-server
          git pull
      
          # 가상환경 없으면 생성
          [ ! -d "venv" ] && python3 -m venv venv
      
          # 가상환경 활성화
          source venv/bin/activate
      
          # 패키지 설치
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # 서버 실행 전 기존 프로세스 종료
          fuser -k 8000/tcp || true

          # 서버 실행 (출력/입력 분리)
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > /dev/null 2>&1 < /dev/null &

        EOF
