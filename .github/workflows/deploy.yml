name: Deploy to EC2 with tmux

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_KEY }}

    - name: Deploy to EC2 using tmux
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@52.78.212.96 << 'EOF'
          cd ~/blackcows-server
          git pull
          
          # Python ìºì‹œ íŒŒì¼ ì‚­ì œ
          find . -type f -name "*.pyc" -delete
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" > .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=30" >> .env
          echo "REFRESH_TOKEN_EXPIRE_DAYS=7" >> .env
          echo "ENVIRONMENT=production" >> .env
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "FIREBASE_PRIVATE_KEY_ID=${{ secrets.FIREBASE_PRIVATE_KEY_ID }}" >> .env
          echo "FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}" >> .env
          echo "FIREBASE_CLIENT_ID=${{ secrets.FIREBASE_CLIENT_ID }}" >> .env
          echo "FIREBASE_PRIVATE_KEY=\"${{ secrets.FIREBASE_PRIVATE_KEY }}\"" >> .env

          # .env íŒŒì¼ ê¶Œí•œ ì„¤ì •
          chmod 600 .env

          # ê°€ìƒí™˜ê²½ ì—…ë°ì´íŠ¸
          if [ ! -d "venv" ]; then
            echo "=== ê°€ìƒí™˜ê²½ ìƒì„± ==="
            python3 -m venv venv
          fi
      
          # ê°€ìƒí™˜ê²½ í™œì„±í™”
          source venv/bin/activate
      
          # íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install email-validator

          # Python êµ¬ë¬¸ ê²€ì‚¬
          echo "=== Python êµ¬ë¬¸ ê²€ì‚¬ ==="
          python3 -m py_compile main.py

          # import ë¬¸ì œ ìë™ ìˆ˜ì •
          echo "=== import ë¬¸ì œ ìë™ ìˆ˜ì • ==="
          if grep -q "routes.livestock_trace" main.py; then
            sed -i '/routes\.livestock_trace/d' main.py
            sed -i '/livestock_router/d' main.py
            echo "âœ… ë¬¸ì œ ìˆëŠ” import ì œê±° ì™„ë£Œ"
          fi

          # tmux ì„¸ì…˜ í™•ì¸ ë° ì„œë²„ ì¬ì‹œì‘
          echo "=== tmux ì„¸ì…˜ ê´€ë¦¬ ==="
          
          # ê¸°ì¡´ blackcows-sessionì´ ìˆëŠ”ì§€ í™•ì¸
          if tmux has-session -t blackcows-session 2>/dev/null; then
            echo "âœ… ê¸°ì¡´ blackcows-session ë°œê²¬ - ì„œë²„ ì¬ì‹œì‘"
            
            # ê¸°ì¡´ ì„¸ì…˜ì—ì„œ ì„œë²„ ì¢…ë£Œ
            tmux send-keys -t blackcows-session C-c
            sleep 3
            
            # ìƒˆ ì„œë²„ ì‹œì‘ ëª…ë ¹ ì „ì†¡
            tmux send-keys -t blackcows-session "cd ~/blackcows-server" Enter
            tmux send-keys -t blackcows-session "source venv/bin/activate" Enter
            tmux send-keys -t blackcows-session "uvicorn main:app --host 0.0.0.0 --port 8000 --reload" Enter
            
            echo "âœ… ê¸°ì¡´ tmux ì„¸ì…˜ì—ì„œ ì„œë²„ ì¬ì‹œì‘ ì™„ë£Œ"
            
          else
            echo "âš ï¸ blackcows-session ì—†ìŒ - ìƒˆë¡œ ìƒì„±"
            
            # ìƒˆ tmux ì„¸ì…˜ ìƒì„± ë° ì„œë²„ ì‹œì‘
            tmux new-session -d -s blackcows-session -c ~/blackcows-server
            tmux send-keys -t blackcows-session "source venv/bin/activate" Enter
            tmux send-keys -t blackcows-session "uvicorn main:app --host 0.0.0.0 --port 8000 --reload" Enter
            
            echo "âœ… ìƒˆ tmux ì„¸ì…˜ ìƒì„± ë° ì„œë²„ ì‹œì‘ ì™„ë£Œ"
          fi

          # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
          echo "=== ì„œë²„ ì‹œì‘ ëŒ€ê¸° (10ì´ˆ) ==="
          sleep 10

          # tmux ì„¸ì…˜ ìƒíƒœ í™•ì¸
          echo "=== tmux ì„¸ì…˜ ìƒíƒœ í™•ì¸ ==="
          if tmux has-session -t blackcows-session 2>/dev/null; then
            echo "âœ… blackcows-session ì‹¤í–‰ ì¤‘"
            
            # ì„¸ì…˜ ë‚´ìš© í™•ì¸
            echo "=== tmux ì„¸ì…˜ ìµœê·¼ ë¡œê·¸ í™•ì¸(15ì¤„) ==="
            tmux capture-pane -t blackcows-session -p | tail -15
            echo "ë¡œê·¸ í™•ì¸ ì‹œê°„: $(date)"
            
            # ì—ëŸ¬ê°€ ìˆëŠ”ì§€ ë³„ë„ í™•ì¸
            echo "=== ì—ëŸ¬ ë¡œê·¸ í™•ì¸ ==="
            ERROR_COUNT=$(tmux capture-pane -t blackcows-session -p | grep -i error | wc -l)
            if [ $ERROR_COUNT -gt 0 ]; then
              echo "âš ï¸ ì—ëŸ¬ ë°œê²¬ ($ERROR_COUNTê°œ):"
              tmux capture-pane -t blackcows-session -p | grep -i error | tail -3
            else
              echo "âœ… ì—ëŸ¬ ì—†ìŒ"
            fi
          else
            echo "âŒ blackcows-session ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"
            exit 1
          fi

          # í¬íŠ¸ ìƒíƒœ í™•ì¸
          echo "=== í¬íŠ¸ 8000 ìƒíƒœ í™•ì¸ ==="
          PORT_CHECK_SUCCESS=false
          
          # ss ëª…ë ¹ì–´ë¡œ í™•ì¸
          if ss -tlnp | grep ':8000'; then
            echo "âœ… í¬íŠ¸ 8000 ì‚¬ìš© ì¤‘ (ss í™•ì¸)"
            PORT_CHECK_SUCCESS=true
          fi
          
          # lsofë¡œë„ í™•ì¸
          if command -v lsof >/dev/null 2>&1; then
            if lsof -i:8000 >/dev/null 2>&1; then
              echo "âœ… í¬íŠ¸ 8000 ì‚¬ìš© ì¤‘ (lsof í™•ì¸)"
              PORT_CHECK_SUCCESS=true
            fi
          fi
          
          # Python í”„ë¡œì„¸ìŠ¤ë¡œë„ í™•ì¸
          if ps aux | grep uvicorn | grep -v grep | grep 8000; then
            echo "âœ… uvicorn í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘"
            PORT_CHECK_SUCCESS=true
          fi

          # í—¬ìŠ¤ì²´í¬ 
          echo "=== í—¬ìŠ¤ì²´í¬ ==="
          sleep 5
          
          HEALTH_CHECK_SUCCESS=false
          ROOT_CHECK_SUCCESS=false
          
          # /health ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
          if curl -f -m 10 http://localhost:8000/health >/dev/null 2>&1; then
            echo "âœ… /health ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ ì„±ê³µ"
            HEALTH_CHECK_SUCCESS=true
          fi
          
          # ë£¨íŠ¸ ê²½ë¡œ í™•ì¸
          if curl -f -m 10 http://localhost:8000/ >/dev/null 2>&1; then
            echo "âœ… ë£¨íŠ¸ ê²½ë¡œ ì‘ë‹µ ì„±ê³µ"
            ROOT_CHECK_SUCCESS=true
          fi

          # ìµœì¢… ê²°ê³¼ íŒì • (ì¡°ê±´ ì™„í™”)
          if [ "$HEALTH_CHECK_SUCCESS" = true ] || [ "$ROOT_CHECK_SUCCESS" = true ] || [ "$PORT_CHECK_SUCCESS" = true ]; then
            echo "ğŸ‰ ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ¯ ì„œë²„ ì ‘ì†: http://52.78.212.96:8000"
            echo "ğŸ“š API ë¬¸ì„œ: http://52.78.212.96:8000/docs"
            echo "ğŸ–¥ï¸ tmux ì„¸ì…˜ ì ‘ì†: tmux attach-session -t blackcows-session"
            
            # ìµœì¢… ìƒíƒœ ìš”ì•½
            echo ""
            echo "=== ë°°í¬ ìƒíƒœ ìš”ì•½ ==="
            echo "âœ… Git ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            echo "âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
            echo "âœ… tmux ì„¸ì…˜ ê´€ë¦¬ ì™„ë£Œ"
            if [ "$HEALTH_CHECK_SUCCESS" = true ]; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ í†µê³¼"
            fi
            if [ "$ROOT_CHECK_SUCCESS" = true ]; then
              echo "âœ… ë£¨íŠ¸ ê²½ë¡œ ì‘ë‹µ ì •ìƒ"
            fi
            if [ "$PORT_CHECK_SUCCESS" = true ]; then
              echo "âœ… í¬íŠ¸ 8000 ì •ìƒ ì‚¬ìš©"
            fi
            echo "ğŸš€ ë°°í¬ ì„±ê³µ!"
            
          else
            echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨ - ìƒì„¸ ë¡œê·¸ í™•ì¸"
            echo "=== tmux ì„¸ì…˜ ì „ì²´ ë¡œê·¸ ==="
            tmux capture-pane -t blackcows-session -p
            echo "=== Python í”„ë¡œì„¸ìŠ¤ í™•ì¸ ==="
            ps aux | grep python
            exit 1
          fi

        EOF
